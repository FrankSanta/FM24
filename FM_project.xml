<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>// Place global declarations here.

//room size
const int N = 20;
const int M = 10;
const int N_resp = 2;     // numer of first responders
const int T_fr = 5;       // assistance time of a first responder
const int T_zr = 7;       // assistance time of a first responder
const int Nv = 3;
const int MAX = 10000;

int map[N][M];

typedef struct {
    int x;
    int y;
} pos_t;

// Entity type
const int SURVIVOR = 0;
const int VICTIM = 1;
const int FIRST_RESPONDER = 2;
const int DRONE = 3;

// Tile type in the map
const int FREE = 0;
const int FIRE = 1;
const int EXIT = 2;

int entities[4] = {5, 3, 4, 2};
pos_t survivors[entities[SURVIVOR]];
pos_t victims[entities[VICTIM]];
pos_t responders[entities[FIRST_RESPONDER]];
pos_t drones[entities[DRONE]];

typedef pos_t pos_arr_t[4];
pos_arr_t positions = {survivors, victims, responders, drones};

// Drone -&amp;gt; Civilian events
urgent chan rescue[entities[SURVIVOR]], callFirstResponder[entities[SURVIVOR]], waitForSurvivor[entities[FIRST_RESPONDER]], goToVictim[entities[FIRST_RESPONDER]];
pos_t victimPos[entities[FIRST_RESPONDER]-1];

// Manhattan distance since motion is on the 4 cardinal directions
int distance(pos_t pos1, pos_t pos2){
    int dist_x = pos1.x-pos2.x;
    int dist_y = pos1.y-pos2.y;
    if(dist_x &lt; 0){
        dist_x = -dist_x;
    }
    if(dist_y &lt; 0){
        dist_y = -dist_y;
    }
    return dist_x+dist_y;
}

// Returns the ID of the closest entity
int utilGetClosest(int type, pos_t pos) {
    int closest = MAX;
    int closestDist = MAX;
    int temp;
    int k;
    for(k=0; k&lt;entities[type]; k++) {
        temp = distance(pos, positions[type][k]);
        if(temp &lt; closestDist){
            closest = k;
            closestDist = temp;      
        }
    }
    return closest;
}

// Returns the pos_t of the closest entity
pos_t utilGetClosestPos(int type, pos_t pos) {
    return positions[type][utilGetClosest(type, pos)];
}

pos_t randomShift() {
    int choice = random(4);
    pos_t toRet;
    if (choice == 0) {
        toRet.x = 0;
        toRet.y = 1;
    }
    if (choice == 1) {
        toRet.x = 0;
        toRet.y = -1;
    }
    if (choice == 2) {
        toRet.x = 1;
        toRet.y = 1;
    }
    if (choice == 3) {
        toRet.x = 1;
        toRet.y = -1;
    }
    return toRet;
}

bool isOccupied(pos_t p) {
    int i;
    for (i = 0; i &lt; entities[SURVIVOR]; i++) {
        if (survivors[i].x == p.x &amp;&amp; survivors[i].y == p.y) {
            return true;
        }
    }
    for (i = 0; i &lt; entities[FIRST_RESPONDER]; i++) {
        if (responders[i].x == p.x &amp;&amp; responders[i].y == p.y) {
            return true;
        }
    }
    for (i = 0; i &lt; entities[VICTIM]; i++) {
        if (victims[i].x == p.x &amp;&amp; victims[i].y == p.y) {
            return true;
        }
    }
    return false;
}</declaration>
	<template>
		<name x="5" y="5">Responder</name>
		<parameter>const id_resp id</parameter>
		<declaration>// Place local declarations here.
clock t_resp;
int id;

process Responder(int assignedId, int assignedX, int assignedY){
    t_resp = 0;
    id = assignedId;
    responders[id].x = assignedX;
    responders[id].y = assignedY;
}

void move() {    
    pos_t newPos;
    do {
        newPos = randomShift();
        newPos.x += responders[id].x
        newPos.y += responders[id].y
    } while (isOccupied(newPos));

    responders[id] = newPos;
    t_resp = 0;
}

// Returns the ID of the closest entity, using the util function
int getClosest(int type) {
    return utilGetClosest(type, responders[id]);
}

// Returns the pos_t of the closest entity, using the util function
pos_t getClosestPos(int type) {
    return utilGetClosestPos(type, responders[id]);
}
</declaration>
		<location id="id0" x="-1105" y="-552">
			<name x="-1088" y="-552">Deciding</name>
			<committed/>
		</location>
		<location id="id1" x="-773" y="-841">
			<name x="-748" y="-867">Helping</name>
			<label kind="invariant" x="-748" y="-850">t_resp &lt;= T_fr</label>
		</location>
		<location id="id2" x="-773" y="-331">
			<name x="-748" y="-348">Reaching</name>
			<label kind="invariant" x="-748" y="-331">t_resp &lt;= distance(responders[id], victimPos[id])</label>
		</location>
		<location id="id3" x="-1513" y="-552">
			<name x="-1581" y="-569">Moving</name>
			<label kind="invariant" x="-1624" y="-552">t_resp &lt;= 1</label>
		</location>
		<location id="id4" x="-1105" y="-331">
			<name x="-1292" y="-340">Waiting for survivor</name>
		</location>
		<init ref="id0"/>
		<transition id="id5">
			<source ref="id4"/>
			<target ref="id2"/>
			<label kind="synchronisation" x="-1003" y="-323">goToVictim[id]?</label>
			<label kind="assignment" x="-986" y="-297">t_resp = 0</label>
		</transition>
		<transition id="id6">
			<source ref="id0"/>
			<target ref="id4"/>
			<label kind="synchronisation" x="-1096" y="-450">waitForSurvivor[id]?</label>
		</transition>
		<transition id="id7">
			<source ref="id0"/>
			<target ref="id1"/>
			<label kind="guard" x="-1292" y="-875">distance(pos, getClosestPos(VICTIM)) &lt;= 1</label>
			<nail x="-1105" y="-841"/>
		</transition>
		<transition id="id8">
			<source ref="id0"/>
			<target ref="id3"/>
			<label kind="guard" x="-1462" y="-603">distance(pos, getClosestPos(VICTIM)) &gt; 1</label>
			<label kind="assignment" x="-1360" y="-578">t_resp = 0</label>
		</transition>
		<transition id="id9">
			<source ref="id2"/>
			<target ref="id1"/>
			<label kind="guard" x="-773" y="-590">t_resp &gt;= distance(responders[id], victimPos[id])</label>
			<label kind="assignment" x="-765" y="-561">t_resp = 0 &amp;&amp; responders[id] = victimPos[id]</label>
		</transition>
		<transition id="id10">
			<source ref="id3"/>
			<target ref="id0"/>
			<label kind="guard" x="-1343" y="-484">t_resp &gt;= 1</label>
			<label kind="assignment" x="-1326" y="-459">move()</label>
			<nail x="-1513" y="-433"/>
		</transition>
		<transition id="id11">
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="guard" x="-1037" y="-739">t_resp &gt;= T_fr</label>
			<label kind="assignment" x="-1028" y="-714">t_resp = 0 &amp;&amp; responders[id] = victimPos[id]</label>
		</transition>
	</template>
	<template>
		<name>Drone</name>
		<declaration>// Place local declarations here.

clock c; 

int id;
pos_t dir;

process Drone(int assignedId, int assignedX, int assignedY){
    c=0;
    id = assignedId;
    drones[id].x = assignedX;
    drones[id].y = assignedY;
}

void patrol() {
    if (drones[id].x + dir.x &lt;= Nv - 1 || drones[id].x + dir.x &gt;= N - Nv) &amp;&amp; //hit both bounds
       (drones[id].y + ydir &lt;= Nv - 1 || drones[id].y + ydir &gt;= M - Nv) {  //flip directions and restart
        dir.x = -dir.x;
        dir.y = -dir.y;
        if(drones[id].x + dir.x &gt; Nv - 1 &amp;&amp; drones[id].x + dir.x &lt; N - Nv){ //if can move x do it
            drones[id].x += dir.x;
        }
        //else stand still
    }
    else if (drones[id].x + dir.x &gt; Nv - 1 &amp;&amp; drones[id].x + dir.x &lt; N - Nv) { //if in bound move along x
        drones[id].x += dir.x;
    }
    else { // move y until new track
        drones[id].y += dir.y;
        if ((drones[id].y - Nv) % (2 * Nv + 1) == 0) { //on the last y-move flip x direction
            dir.x = -dir.x;
        }
    }
}

bool survivorNear() {
    if ( distance(pos, getClosestPos(SURVIVOR) &gt; Nv || distance(pos, getClosestPos(VICTIM) &gt; Nv  )
        return false;
    return true
}

bool survivorWillHelp() {
    if ( distance(getClosestPos(SURVIVOR), getClosestPos(VICTIM)) &lt; distance(getClosestPos(SURVIVOR), getClosestPos(FIRST_RESPONDER)) + distance(getClosestPos(FIRST_RESPONDER), getClosestPos(VICTIM)) )
        return true;
    return false;
}

// Returns the ID of the closest entity, using the util function
int getClosest(int type) {
    return utilGetClosest(type, drones[id]);
}

// Returns the pos_t of the closest entity, using the util function
pos_t getClosestPos(int type) {
    return utilGetClosestPos(type, drones[id]);
}</declaration>
		<location id="id12" x="-59" y="-68">
			<name x="-93" y="-110">Deciding</name>
			<committed/>
		</location>
		<location id="id13" x="-246" y="-195">
			<name x="-256" y="-229">Moving</name>
			<label kind="invariant" x="-256" y="-178">t&lt;=1</label>
		</location>
		<location id="id14" x="-59" y="314">
			<name x="-110" y="348">Communicating</name>
			<committed/>
		</location>
		<init ref="id12"/>
		<transition id="id15">
			<source ref="id14"/>
			<target ref="id12"/>
			<label kind="guard" x="-51" y="59">survivorWillHelp()</label>
			<label kind="synchronisation" x="-51" y="93">rescue[getClosest(SURVIVOR)]!</label>
		</transition>
		<transition id="id16">
			<source ref="id14"/>
			<target ref="id12"/>
			<label kind="guard" x="289" y="51">!survivorWillHelp()</label>
			<label kind="synchronisation" x="289" y="85">callFirstResponder[getClosest(SURVIVOR))]! &amp;&amp;
waitForSurvivor[getClosest(FIRST_RESPONDER)]!</label>
			<nail x="280" y="204"/>
			<nail x="280" y="-17"/>
		</transition>
		<transition id="id17">
			<source ref="id12"/>
			<target ref="id14"/>
			<label kind="guard" x="-510" y="93">survivorNear()</label>
			<nail x="-373" y="17"/>
			<nail x="-374" y="246"/>
		</transition>
		<transition id="id18">
			<source ref="id13"/>
			<target ref="id12"/>
			<label kind="guard" x="-178" y="-85">t&gt;=1</label>
			<label kind="assignment" x="-178" y="-59">t=0</label>
			<nail x="-187" y="-102"/>
			<nail x="-187" y="-102"/>
		</transition>
		<transition id="id19">
			<source ref="id12"/>
			<target ref="id13"/>
			<label kind="guard" x="-144" y="-204">!survivorNear()</label>
			<nail x="-136" y="-178"/>
		</transition>
	</template>
	<template>
		<name x="5" y="5">Survivor</name>
		<parameter>distance survHelpingTime respHelpingTime</parameter>
		<declaration>// Place local declarations here.
clock t;
int id;

process Survivor(int assignedId, int assignedX, int assignedY){
    t = 0;
    id = assignedId;
    survivors[id].x = assignedX;
    survivors[id].y = assignedY;
}

void move() {    
    pos_t newPos;
    do {
        newPos = randomShift();
        newPos.x += responders[id].x
        newPos.y += responders[id].y
    } while (isOccupied(newPos));

    survivors[id] = newPos;
    t = 0;
}

// Returns the ID of the closest entity, using the util function
int getClosest(int type) {
    return utilGetClosest(type, survivors[id]);
}

// Returns the pos_t of the closest entity, using the util function
pos_t getClosestPos(int type) {
    return utilGetClosestPos(type, survivors[id]);
}</declaration>
		<location id="id20" x="-170" y="119">
			<name x="-263" y="110">Deciding</name>
			<committed/>
		</location>
		<location id="id21" x="408" y="348">
			<name x="433" y="340">Moving</name>
			<label kind="invariant" x="441" y="365">t&lt;=1</label>
		</location>
		<location id="id22" x="977" y="119">
			<name x="1011" y="110">Safe</name>
		</location>
		<location id="id23" x="620" y="119">
			<name x="594" y="85">Helping</name>
			<label kind="invariant" x="586" y="59">t &lt;= T_zr</label>
		</location>
		<location id="id24" x="197" y="119">
			<name x="136" y="85">Reaching alone</name>
			<label kind="invariant" x="-8" y="59">t &lt;= distance(survivors[id], getClosestPos(VICTIM))</label>
		</location>
		<location id="id25" x="-170" y="-76">
			<name x="-289" y="-85">Reaching FR</name>
			<label kind="invariant" x="-450" y="-119">t &lt;= distance(survivors[id], getClosestPos(FIRST_RESPONDER))</label>
		</location>
		<location id="id26" x="977" y="-76">
			<name x="1003" y="-85">Helping with FR</name>
			<label kind="invariant" x="1020" y="-110">t &lt;= T_fr</label>
		</location>
		<location id="id27" x="408" y="-76">
			<name x="349" y="-110">Reaching victim</name>
			<label kind="invariant" x="221" y="-136">t &lt;= distance(survivors[id], getClosestPos(VICTIM))</label>
		</location>
		<init ref="id20"/>
		<transition id="id28">
			<source ref="id27"/>
			<target ref="id26"/>
			<label kind="guard" x="501" y="-68">t &gt;= distance(survivors[id], getClosestPos(VICTIM))</label>
			<label kind="assignment" x="527" y="-42">t = 0 &amp;&amp; survivors[id]=getClosestPos(VICTIM)</label>
		</transition>
		<transition id="id29">
			<source ref="id25"/>
			<target ref="id27"/>
			<label kind="guard" x="-119" y="-68">t &gt;= distance(survivors[id], getClosestPos(FIRST_RESPONDER))</label>
			<label kind="synchronisation" x="-68" y="-17">goToVictim[getClosest(FIRST_RESPONDER)]!</label>
			<label kind="assignment" x="-119" y="-42">t = 0 &amp;&amp; survivors[id] = getClosestPos(FIRST_RESPONDER)</label>
			<nail x="391" y="-76"/>
		</transition>
		<transition id="id30">
			<source ref="id26"/>
			<target ref="id22"/>
			<label kind="guard" x="986" y="8">t &gt;= T_fr</label>
		</transition>
		<transition id="id31">
			<source ref="id20"/>
			<target ref="id25"/>
			<label kind="synchronisation" x="-365" y="17">callFirstResponder[id]?</label>
		</transition>
		<transition id="id32">
			<source ref="id24"/>
			<target ref="id23"/>
			<label kind="guard" x="204" y="136">t &gt;= distance(survivors[id], getClosestPos(VICTIM))</label>
			<label kind="assignment" x="391" y="161">t = 0</label>
		</transition>
		<transition id="id33">
			<source ref="id20"/>
			<target ref="id24"/>
			<label kind="synchronisation" x="-42" y="127">rescue[id]?</label>
		</transition>
		<transition id="id34">
			<source ref="id23"/>
			<target ref="id22"/>
			<label kind="guard" x="756" y="127">t &gt;= T_zr</label>
		</transition>
		<transition id="id35">
			<source ref="id21"/>
			<target ref="id20"/>
			<label kind="guard" x="42" y="238">t&gt;=1 &amp;&amp; !nearExit()</label>
			<nail x="119" y="306"/>
			<nail x="-51" y="212"/>
		</transition>
		<transition id="id36">
			<source ref="id21"/>
			<target ref="id22"/>
			<label kind="guard" x="705" y="238">nearExit()</label>
		</transition>
		<transition id="id37">
			<source ref="id20"/>
			<target ref="id21"/>
			<label kind="assignment" x="-68" y="314">t=0 &amp;&amp; move()</label>
			<nail x="-85" y="246"/>
			<nail x="102" y="348"/>
		</transition>
	</template>
	<system>// Place template instantiations here.
resp1 = Responder(1);
resp2 = Responder(2);

// List one or more processes to be composed into a system.
system resp1, resp2;
</system>
	<queries>
		<query>
			<formula/>
			<comment/>
		</query>
	</queries>
</nta>
